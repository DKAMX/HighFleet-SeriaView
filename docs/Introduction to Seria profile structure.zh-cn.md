# Seria存档入门

[English](Introduction%20to%20Seria%20profile%20structure.md)  

Seria文件中的键值对格式类似于INI配置文件，而成对的花括号又让它和JSON文件的格式类似。这使得Seria文件形成了一个递进的，类似于树状的结构。  
一些关键点：

- Seria文件具有嵌套的，成对出现的花括号
- 每对花括号中的内容都以一个`m_classname`的属性开头

了解这些以后，我们就可以开始分析存档的结构并理解每一部分的含义。一些名词使用的注意事项：因为Seria文件有类似树状的结构，为了方便，我会称呼存档力的每一对花括号以及其中的内容为一个节点。例如，`Profile`节点是整个存档的根节点，`Escadra`节点是`Profile`节点直接相连的子节点。但是，需要注Seria文件中`m_classname`属性有一个值就叫`Node`。请注意区分两者的含义。

## 存档构成

```
Profile
├── Escadra
|   [...]
├── Escadra
├── Location
|   [...]
├── Location
├── NPC
|   [...]
├── NPC
├── Item
|   [...]
├── Item
├── Node
└── LastPlayerPosData
```

上面呈现的是一个典型的战役中期的存档结构。`[...]`指代的是和之前那个节点一样的一系列节点，因为有百十个之多，所以在此省略了。  
`Escadra`，顾名思义，是有关地图上船只信息的节点。这包括商船，打击团以及玩家的舰队等。  
`Location`存有地图上城市的信息，其中包括无线电呼号，城市类型（如，燃料站），城市售卖的零部件和弹药等。  
`NPC`包含所有可以在游戏内招募的NPC的信息。除此之外，所有可以购买的船只在技术上也被定义了一个NPC（仔细观察这些NPC节点，会发现每个NPC都有自己的名字，以及性格，像是善恶值等）  
存档的末尾有少数`Item`节点，这些节点直接作为`Profile`根节点的子节点。据目前所知，这些节点含有玩家弹药库的信息（因为游戏中不论是分舰队还是主力舰队的船只都可以使用弹药库，这在概念上并不属于某一个船只或者地点，是“虚空”弹药库。可能因此这些节点被放在存档末尾）  
最后一个`Node`节点，包含了玩家在战略地图上自定义的标记（如，文字标记和箭头）。还可能被用于存放船只物品栏的零部件（这一点暂时不确定，需要进一步验证）。  

### Escadra

```
Escadra
├── Node
│   ├── Frame
│   ├── Body
|   |   [...]
│   ├── Body
│   ├── Joint
│   |   [...]
│   └── Joint
├── Intel
|   [...]
├── Intel
├── Escadra::MapShip
└── Node
    ├── Body
    |   [...]
    └── Body
```

上面是`Escadra`节点的具体结构。第一个节点是对战舰构造的定义，紧接着是和这艘战舰有关的情报，却决于是敌方战舰还是玩家战舰。如果是敌方战舰，则是该敌方战舰发出的情报。如果是玩家战舰，则是这艘战舰截获的情报。`Escadra::MapShip`节点定义了这艘战舰在战略地图上的位置。最后一个`Node`节点存储了有关该船只物品栏的信息。因为我们知道当分舰队购买了一个零部件后，这个零部件会一直跟着这个分舰队，直到该舰队与旗舰舰队合并。因此在技术层面，零部件是单独存放在每艘船里的，只是游戏有一个零部件合并转移到旗舰上的机制。`Node`节点中的没一个`Body`节点，定义了每一个零部件的类型数量等信息，以及这个零部件所属的物品栏（这一点很重要，也是我们能够对物品栏进行修改的基础）。  
基于这些信息，我们可以对物品栏进行修改，在游戏外实现零部件的转移和分配。这样分舰队随时都可以从旗舰哪里获得如导弹等的补给，或者直接作弊刷出任意数量的物品。  

### Location

```
Location
├── Item
|   [...]
├── Item
└── Node
    ├── Body
    |   [...]
    └── Body
```

上面是一个典型的`Location`节点的构造。开头一系列的`Item`节点包含了该城市商人售卖的弹药种类。每一个`Item`节点代表一种弹药类型。最后一个`Node`节点包含了船坞售卖的所有零部件。每一个`Body`子节点代表了一种零部件。这一点和船只的物品栏类似。

## 如何修改玩家的弹药库

```
m_items=2199023255555
{
m_classname=Item
m_code=2199023255555
m_index=31              <- 弹药类型
m_count=10              <- 弹药数量
}
```

既然我们知道存档末尾的一系列`Item`节点是和弹药库有关的。修改就很简单了：翻到存档末尾，找到你想要修改的那个弹药节点进行修改即可。参见上面的例子，先根据`m_index`属性值确认弹药的类型，然后修改`m_count`来改变弹药的数量。  

## 如何修改船只的物品栏

```
m_listMapShips=1099511627779
{
m_classname=Escadra::MapShip
m_code=1099511627779
pBody.id=-463428086934121687
pEscadra.id=5264246570316703104     <- 指向Escadra节点的m_id属性
pCreature.id=-1392318650740825770
prevCurs=0.000243006
}
m_inventory=7
{
m_classname=Node
m_code=7
m_id=-2128173247453172687
m_children=15
{
m_classname=Body
m_code=15
m_id=3524251657124933523
m_name=BOMB
m_state=2
m_master_id=-2128173247453172687    <- 指向Node（物品栏）节点的m_id属性
    [...]
{
m_classname=Mesh
m_size=4
    [...]
}
m_layer=3
m_slot_type=5
m_oid=MDL_BOMB_01                   <- 零部件类型
m_count=30                          <- 零部件数量
is_loot=true
m_explosive=500
    [...]
}
    [...]
}
```

定位一个`Node`（物品栏）节点的最简单的方法就是寻找`Escadra::MapShip`节点。用文本编辑器打开存档按住`ctrl`+`f`键使用搜索功能。`Escadra::MapShip`节点还包含了如`pEscadra.id`属性，可以帮你确认这个物品栏归属的船只。毕竟存档太长了直接翻找比较困难。紧接着的`Node`节点包含一个`m_id`属性值是每个物品栏独有的。上述例子中，这个炸弹所在的`Body`节点就有一个`m_master_id`和物品栏的id相对应。  
**注意：当你复制或新增零部件到另一个物品栏里时，确保这两个属性修改成目标物品栏的id，而不是原来物品栏的id。如果弄错了或导致游戏在着陆后进入城市的一瞬间卡死。小心谨慎，记得备份存档！**  
另一个值得注意的属性是`m_count`，定义了零部件的属性。想象一下指挥拥有数百枚导弹的舰队，我们一定能给Gerat带去和平！

## 参考

[The Ultimate HighFleet Modding Guide](https://steamcommunity.com/sharedfiles/filedetails/?id=2768442721)
